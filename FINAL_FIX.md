# âœ… Questions Not Adding - FIXED!

## ğŸ” Root Cause
**Foreign key constraint violated: `Question_departmentId_fkey`**

The `QuestionForm` was using **hardcoded department IDs** (`'d1'`, `'d2'`, etc.) but the database had **different IDs** generated by Prisma (like `'cmj6vlvvx0000ddas2ghkpx02'`).

When you selected "Engineering" from the dropdown, it was sending `departmentId: 'd1'` to the API, but no department with ID `'d1'` exists in the database!

---

## ğŸ”§ The Fix

### **Before:**
```typescript
// QuestionForm.tsx
const mockDepartments = [
  { id: 'd1', name: 'Engineering' },  // âŒ Hardcoded IDs
  { id: 'd2', name: 'Product Design' },
  ...
];

<select name="departmentId">
  {mockDepartments.map(dept => ...)}  // âŒ Using mock data
</select>
```

### **After:**
```typescript
// QuestionForm.tsx
import { useDBDataStore } from '@/store/dbData';

const { departments, fetchDepartments } = useDBDataStore();

useEffect(() => {
  fetchDepartments();  // âœ… Load from database
}, [fetchDepartments]);

<select name="departmentId">
  {departments.map(dept => ...)}  // âœ… Using real database IDs
</select>
```

---

## ğŸ“Š What Was Happening

### **1. Database IDs vs Form IDs**
```
Database Departments:
  - cmj6vlvvx0000ddas2ghkpx02 â†’ "Engineering"
  - cmj6vlvvy0001ddas... â†’ "Product Design"
  ...

Form Dropdown (Before Fix):
  - d1 â†’ "Engineering"  âŒ ID doesn't exist!
  - d2 â†’ "Product Design"  âŒ ID doesn't exist!
```

### **2. Submission Flow**
```
1. User fills form and selects "Engineering"
2. Form sends: { departmentId: 'd1', ... }
3. API tries: INSERT INTO Question (departmentId = 'd1', ...)
4. PostgreSQL checks: Does department 'd1' exist?
5. Result: NO! Foreign key constraint violated âŒ
6. Transaction ROLLBACK
7. Question not created
```

---

## âœ… Now It Works

### **Correct Flow:**
```
1. Form loads â†’ fetchDepartments() from database
2. Dropdown shows real departments with real IDs
3. User selects "Engineering" â†’ departmentId: 'cmj6vlvvx0000ddas...'
4. API tries: INSERT INTO Question (departmentId = 'cmj6vlvvx...', ...)
5. PostgreSQL checks: Does department 'cmj6vlvvx...' exist?
6. Result: YES! âœ…
7. Transaction COMMIT
8. Question created successfully!
```

---

## ğŸ¯ Test It Now

### **Steps:**
1. Go to: http://localhost:3000/admin/questions
2. Click "Add Question"
3. Fill in the form:
   - Title: "Test Question"
   - Description: "Testing database insert"
   - Answer Type: Multiple Choice
   - **Department: Engineering** â† This now uses the real database ID!
   - Difficulty: Beginner
   - Skill Type: Technical
   - Tags: test
4. Click "Create Question"
5. âœ… Question appears immediately!
6. Refresh page â†’ âœ… Question persists!

---

## ğŸ“ Files Modified

**1. `src/components/admin/QuestionForm.tsx`**
- Added: `import { useDBDataStore } from '@/store/dbData';`
- Added: `const { departments, fetchDepartments } = useDBDataStore();`
- Added: `useEffect(() => { fetchDepartments(); }, [fetchDepartments]);`
- Changed: `{mockDepartments.map(...)}` â†’ `{departments.map(...)}`
- Removed: `const mockDepartments = [...]`

---

## ğŸ” How to Verify

### **Check Real Department IDs:**
```bash
npm run db:studio
```
1. Go to http://localhost:5555
2. Click "Department"
3. See the actual IDs (long alphanumeric strings)

### **Test Question Creation:**
Open browser console â†’ Network tab â†’ Try creating a question â†’ Check the request payload:
```json
{
  "departmentId": "cmj6vlvvx0000ddas2ghkpx02",  // âœ… Real ID from database!
  "title": "Test Question",
  ...
}
```

---

## ğŸ’¡ Why This Happened

When we ran the seed script:
```javascript
await prisma.department.create({
  id: 'd1',  // We tried to set ID to 'd1'
  name: 'Engineering',
});
```

But Prisma uses `@default(cuid())` which **overrides** manual IDs unless you explicitly tell it not to. So the database generated its own IDs!

---

## âœ… Summary

| Issue | Status |
|-------|--------|
| Foreign key constraint error | âœ… Fixed |
| Form using hardcoded IDs | âœ… Fixed |
| Form now loads from database | âœ… Fixed |
| Questions can be created | âœ… Working |
| Questions persist after refresh | âœ… Working |

---

**Try creating a question now - it will work!** ğŸ‰

